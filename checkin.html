<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Location Sender</title>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
      background: linear-gradient(135deg, #ff7e3a 0%, #ff6b35 100%);
      color: white;
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(255, 107, 53, 0.3);
    }
    .status {
      font-size: 16px;
      margin: 20px 0;
      padding: 12px;
      border-radius: 10px;
      background: rgba(255, 107, 53, 0.1);
      color: #495057;
    }
    .loading {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .success { color: #28a745; background: rgba(40, 167, 69, 0.1); }
    .error { color: #dc3545; background: rgba(220, 53, 69, 0.1); }
    .info { color: #495057; background: rgba(73, 80, 87, 0.1); }
    
    #video {
      width: 60%;
      max-width: 250px;
      height: auto;
      border-radius: 10px;
      display: none;
      transform: scaleX(-1); /* Mirror effect for front camera */
      border: 3px solid #ff6b35;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
      margin: 0 auto; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
    }
    
    #canvas {
      display: none;
    }
    
    #captureBtn {
      background: linear-gradient(135deg, #ff7e3a 0%, #ff6b35 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 15px;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
      transition: all 0.3s ease;
    }
    
    #captureBtn:hover {
      background: linear-gradient(135deg, #ff8a4a 0%, #ff7b45 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
    }
    
    #captureBtn:active {
      transform: scale(0.95);
    }
    
    #preview {
      width: 70%;
      max-width: 200px;
      height: auto;
      border-radius: 10px;
      display: none;
      margin: 15px auto 0 auto; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
      border: 3px solid #28a745;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    #shiftSelector {
      width: 100%;
      max-width: 300px;
      padding: 12px;
      margin: 15px auto;
      border-radius: 12px;
      border: 2px solid #ff6b35;
      font-size: 16px;
      color: #495057;
      background: white;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
    }
    
    #shiftSelector:focus {
      outline: none;
      border-color: #ff8a4a;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
    }
    
    .checkin-type-container {
      display: none;
      margin: 15px auto;
      max-width: 300px;
    }
    
    .checkin-type-options {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .checkin-type-option {
      flex: 1;
    }
    
    .checkin-type-option input[type="radio"] {
      display: none;
    }
    
    .checkin-type-option label {
      display: block;
      padding: 12px 20px;
      border-radius: 12px;
      border: 2px solid #ff6b35;
      background: white;
      color: #495057;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
    }
    
    .checkin-type-option input[type="radio"]:checked + label {
      background: linear-gradient(135deg, #ff7e3a 0%, #ff6b35 100%);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
    }
    
    .checkin-type-option label:hover {
      border-color: #ff8a4a;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="color: #ff6b35; margin-bottom: 10px;">üìç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô + ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</h2>
    <p style="color: #64748b; font-size: 14px; margin-bottom: 20px;">Check-In with Location & Photo</p>
    <div id="status" class="status">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>
    
    <div id="checkinTypeContainer" class="checkin-type-container">
      <div class="checkin-type-options">
        <div class="checkin-type-option">
          <input type="radio" id="checkinIn" name="checkinType" value="in">
          <label for="checkinIn">üîµ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label>
        </div>
        <div class="checkin-type-option">
          <input type="radio" id="checkinOut" name="checkinType" value="out">
          <label for="checkinOut">üî¥ ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</label>
        </div>
      </div>
    </div>
    
    <select id="shiftSelector">
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
      <option value="morning_shift">üåÖ ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (Morning Shift)</option>
      <option value="afternoon_shift">‚òÄÔ∏è ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢ (Afternoon Shift)</option>
      <option value="night_shift">üåô ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (Night Shift)</option>
    </select>
    
    <video id="video" autoplay playsinline></video>
    <button id="captureBtn">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
    <canvas id="canvas"></canvas>
    <img id="preview" alt="Photo Preview" />
  </div>

  <script>
    const updateStatus = (message, type = 'info') => {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    };

    async function autoSendLocation() {
      try {
        const LIFF_ID = "2008451052-lENrQxbq"; // ‡πÉ‡∏™‡πà LIFF ID ‡∏à‡∏≤‡∏Å Login Channel
        
        updateStatus('‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤');

        // Initialize LIFF
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        updateStatus('üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...');

        // Request current location
        const position = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö geolocation'));
            return;
          }

          navigator.geolocation.getCurrentPosition(
            resolve,
            reject,
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        });

        const { latitude, longitude } = position.coords;
        
        updateStatus('üåç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà...');

        // Get address from reverse geocoding (optional)
        let address = `‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: ${latitude.toFixed(6)}, ‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î: ${longitude.toFixed(6)}`;
        try {
          const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=th`);
          const data = await response.json();
          if (data.display_name || data.locality) {
            address = data.display_name || `${data.locality}, ${data.city}, ${data.countryName}`;
          }
        } catch (e) {
          console.warn('Reverse geocoding failed:', e);
          // Use coordinates as fallback
        }

        updateStatus('üìã ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô...');
        
        // Show check-in type selector and wait for selection
        const checkinTypeContainer = document.getElementById('checkinTypeContainer');
        checkinTypeContainer.style.display = 'block';
        
        const checkinType = await new Promise((resolve) => {
          const radios = document.querySelectorAll('input[name="checkinType"]');
          radios.forEach(radio => {
            radio.addEventListener('change', function handler(e) {
              radios.forEach(r => r.removeEventListener('change', handler));
              resolve(e.target.value);
            });
          });
        });
        
        checkinTypeContainer.style.display = 'none';

        updateStatus('‚è∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...');
        
        // Show shift selector and wait for selection
        const shiftSelector = document.getElementById('shiftSelector');
        shiftSelector.style.display = 'block';
        
        const selectedShift = await new Promise((resolve) => {
          shiftSelector.addEventListener('change', function handler(e) {
            if (e.target.value) {
              shiftSelector.removeEventListener('change', handler);
              resolve(e.target.value);
            }
          });
        });
        
        shiftSelector.style.display = 'none';

        updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...');

        // Take photo
        const photoDataUrl = await takePhoto();

        updateStatus('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á + ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...');

        // Send location message with photo
        const messages = [];
        let locationTitle = '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (GPS)';
        let locationAddress = address;
        
        if (photoDataUrl) {
          // Upload photo to server
          const blob = dataURLtoBlob(photoDataUrl);
          const uploadResult = await uploadImageToServer(blob, latitude, longitude, address);
          
          if (uploadResult && uploadResult.imageUrl) {
            // Send photo first
            messages.push({
              type: 'image',
              originalContentUrl: uploadResult.imageUrl,
              previewImageUrl: uploadResult.imageUrl
            });
            
            locationTitle = 'üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + üì∑ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢';
            locationAddress = `${address}\n\n‚úÖ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ô‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤)\nüïê ‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleString('th-TH')}`;
            console.log('Photo uploaded successfully:', uploadResult.imageUrl);
          } else {
            locationTitle = 'üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)';
          }
        }

        // Send location message
        messages.push({
          type: 'location',
          title: locationTitle,
          address: locationAddress,
          latitude: latitude,
          longitude: longitude
        });

        await liff.sendMessages(messages);

        updateStatus('‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ + ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

        // Optional: Also send to your API with more details
        try {
          const profile = await liff.getProfile();
          await fetch('https://nice-ppn.studio/checkin-api/location-from-liff', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: profile.userId,
              displayName: profile.displayName,
              latitude,
              longitude,
              address,
              accuracy: position.coords.accuracy,
              timestamp: new Date().toISOString(),
              source: 'liff-gps-photo',
              hasPhoto: !!photoDataUrl,
              shift: selectedShift,
              checkinType: checkinType
            })
          });
          console.log('Location with photo info, shift, and check-in type saved to API');
        } catch (e) {
          console.warn('Failed to save to API:', e);
        }

        // Close LIFF window after 3 seconds
        setTimeout(() => {
          if (liff.isInClient()) {
            liff.closeWindow();
          }
        }, 3000);

      } catch (error) {
        console.error('Auto location + photo error:', error);
        let errorMessage = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ';
        
        if (error.code === 1) {
          errorMessage += '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á';
        } else if (error.code === 2) {
          errorMessage += '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
        } else if (error.code === 3) {
          errorMessage += '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
        } else {
          errorMessage += error.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
        }
        
        updateStatus(errorMessage, 'error');
        
        // Close window after showing error
        setTimeout(() => {
          if (liff.isInClient()) {
            liff.closeWindow();
          }
        }, 5000);
      }
    }

    async function takePhoto() {
      return new Promise(async (resolve, reject) => {
        try {
          const video = document.getElementById('video');
          const canvas = document.getElementById('canvas');
          const preview = document.getElementById('preview');
          
          // Request camera access
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'user', // Use front camera (selfie camera)
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          });
          
          video.srcObject = stream;
          video.style.display = 'block';
          await video.play();

          // Show capture button
          const captureBtn = document.getElementById('captureBtn');
          captureBtn.style.display = 'block';

          updateStatus('üì∑ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ', 'info');

          // Manual capture only - no auto capture
          let captured = false;
          
          const capturePhoto = () => {
            if (captured) return;
            captured = true;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            // Flip horizontally to match mirror view
            ctx.scale(-1, 1);
            ctx.drawImage(video, -video.videoWidth, 0);
            
            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show preview
            preview.src = dataURL;
            preview.style.display = 'block';
            video.style.display = 'none';
            captureBtn.style.display = 'none';
            
            // Stop camera
            stream.getTracks().forEach(track => track.stop());
            
            updateStatus('‚úÖ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...', 'success');
            resolve(dataURL);
          };

          // Manual capture button only
          captureBtn.addEventListener('click', capturePhoto, { once: true });

        } catch (error) {
          console.error('Camera error:', error);
          reject(error);
        }
      });
    }

    function dataURLtoBlob(dataURL) {
      const arr = dataURL.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    async function uploadImageToServer(blob, latitude, longitude, address) {
      try {
        const formData = new FormData();
        formData.append('image', blob, 'checkin-photo.jpg');
        formData.append('latitude', latitude);
        formData.append('longitude', longitude);
        formData.append('address', address);
        formData.append('timestamp', new Date().toISOString());

          const response = await fetch('https://nice-ppn.studio/checkin-api/upload-photo', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          return result.imageUrl;
        } else {
          console.error('Failed to upload image:', response.status);
          return null;
        }
      } catch (error) {
        console.error('Upload error:', error);
        return null;
      }
    }

    // Start automatically when page loads
    autoSendLocation();
  </script>
</body>
</html>